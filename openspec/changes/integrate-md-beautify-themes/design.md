## 上下文

现有 obsidian-mp-publisher 项目使用基于 JSON 模板配置的主题系统，通过 TemplateManager 将样式以 inline style 方式应用到 DOM 元素。这种方式虽然简单，但存在以下局限：
- 主题样式与 DOM 结构耦合
- 难以实现复杂的 CSS 效果（如伪元素、动画）
- 明暗模式支持需要手动维护多套主题
- 不支持 Mermaid、KaTeX 等高级渲染

外部项目 obsidian-md-beautify-plugin 使用 @mdb/core 包，提供了完整的基于 CSS 的主题系统。需要将这些功能集成到现有项目中。

## 目标 / 非目标

**目标：**
1. 集成 13 个 CSS 预设主题到现有项目
2. 支持 Mermaid 图表实时渲染
3. 支持 KaTeX 数学公式渲染
4. 添加 GitHub 风格代码高亮
5. 实现明暗模式自动/手动切换
6. 提供主题管理器 UI 供用户自定义主题

**非目标：**
- 不修改现有的微信公众号发布核心逻辑
- 不移除现有的 JSON 模板系统（作为备用）
- 不支持 PDF 导出功能（保留现有简单实现）

## 决策

### 1. 渲染引擎选择

**决策：** 使用自定义 markdown-it 解析器替代 Obsidian MarkdownRenderer

**理由：**
- @mdb/core 的核心优势在于其自定义解析器
- 可以精确控制输出的 HTML 结构，便于应用 CSS 主题
- 支持更多 Markdown 扩展（脚注、任务列表、表格目录等）

**替代方案考虑：**
- 继续使用 Obsidian MarkdownRenderer：无法应用完整的 CSS 主题系统

### 2. 主题存储格式

**决策：** 使用 CSS 字符串格式存储主题

**理由：**
- 与 @mdb/core 主题格式完全兼容
- 支持复杂的 CSS 选择器、伪元素、CSS 变量
- 便于用户自定义和主题市场分享

**替代方案考虑：**
- 转换为 JSON 格式：丢失 CSS 高级特性，工作量大

### 3. 样式应用方式

**决策：** 通过注入 `<style>` 标签到预览页面

**理由：**
- 保持 DOM 结构纯净
- 性能更好（无需遍历每个 DOM 元素）
- 便于主题切换

**替代方案考虑：**
- 保持 inline style：与现有实现相同，但无法享受 CSS 优势

### 4. Mermaid 渲染位置

**决策：** 在前端（浏览器端）渲染 Mermaid

**理由：**
- Obsidian 插件运行环境在浏览器中
- Mermaid 官方支持浏览器渲染
- 与现有预览视图架构兼容

### 5. 依赖管理

**决策：** 直接复制 @mdb/core 源代码到项目中，而非作为 npm 依赖

**理由：**
- @mdb/core 是私有 workspace 包，无法通过 npm 安装
- 源代码量适中（约 15 个文件）
- 便于定制和维护

## 风险 / 权衡

### 风险 1：解析器行为差异
**描述：** 自定义 markdown-it 解析器可能与 Obsidian 渲染结果存在差异

**缓解措施：**
- 测试对比两种渲染结果
- 保留现有 MarkdownRenderer 作为后备方案
- 逐步迁移，先从预览视图开始

### 风险 2：样式冲突
**描述：** CSS 主题可能与 Obsidian 原有样式冲突

**缓解措施：**
- 使用 `#mdb` ID 选择器限定作用域
- 预览视图使用独立容器隔离

### 风险 3：微信发布兼容性问题
**描述：** 复制到微信时 CSS 可能丢失

**缓解措施：**
- 使用 juice 库将 CSS 内联到 HTML 元素 style 属性
- @mdb/core ThemeProcessor 已内置此功能

### 风险 4：Mermaid 渲染性能
**描述：** 大量 Mermaid 图表可能影响渲染性能

**缓解措施：**
- 使用异步渲染
- 添加加载状态提示
- 限制单个文档的图表数量

### 权衡 5：代码复杂度增加
**描述：** 集成新功能会增加代码量和维护成本

**缓解措施：**
- 模块化组织代码
- 添加详细注释
- 编写测试用例

## 迁移计划

### Phase 1: 基础设施（预计 1 天）
1. 创建 `src/core/` 目录结构
2. 复制 @mdb/core 核心文件
3. 安装必要依赖

### Phase 2: 核心功能（预计 2 天）
1. 实现 MarkdownParser 集成
2. 实现 ThemeProcessor 集成
3. 重构 converter.ts

### Phase 3: 主题系统（预计 1 天）
1. 添加 13 个预设主题
2. 重构 templateManager.ts
3. 添加主题切换 UI

### Phase 4: 高级功能（预计 2 天）
1. 集成 Mermaid 渲染
2. 集成 KaTeX 支持
3. 添加代码高亮

### Phase 5: 测试与优化（预计 1 天）
1. 功能测试
2. 性能优化
3. 文档更新

## 待解决的问题

1. 是否需要保留现有的 JSON 模板系统作为备用？
2. 主题管理器是否需要支持主题导入/导出功能？
3. 如何处理主题的明暗模式变体？
